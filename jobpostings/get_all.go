package jobpostings

import (
	"context"
	"log"
	"sync"
	"syscall"

	"golang.org/x/sync/semaphore"
)

func maxNumberOfOpenFiles() int64 {
	var rLimit syscall.Rlimit

	err := syscall.Getrlimit(syscall.RLIMIT_NOFILE, &rLimit)

	if err != nil {
		// if error, default to 256
		return 256
	}

	limit := int64(rLimit.Max)

	return limit
}

// GetAllJobPostings finds all of the JobPostings using every source.
func GetAllJobPostings(ctx context.Context) <-chan *JobPosting {
	// cat *.go | grep "\bGet" | grep "ctx" | awk '{print $2}' | awk -F '(' '{print $1","}' | grep "Get" | grep -v "GetAllJob" | pbcopy
	all := []func(ctx context.Context) (<-chan *JobPosting, error){
		Get0xJobPostings,
		Get15FiveJobPostings,
		Get21stCenturyFoxJobPostings,
		Get2UJobPostings,
		Get3MJobPostings,
		GetAbacusJobPostings,
		GetAccionSystemsJobPostings,
		GetAdjustJobPostings,
		GetAdobeJobPostings,
		GetAdvancedDisposalJobPostings,
		GetAESJobPostings,
		GetAffirmJobPostings,
		GetAfreshJobPostings,
		GetAirMapJobPostings,
		GetAirbnbJobPostings,
		GetAirtameJobPostings,
		GetAkronChildrensHospitalJobPostings,
		GetAlterianJobPostings,
		GetAltoJobPostings,
		GetAmazeeJobPostings,
		GetAmenityAnalyticsJobPostings,
		GetAmexJobPostings,
		GetAmyrisJobPostings,
		GetAnchorFreeJobPostings,
		GetAnchorageJobPostings,
		GetApptioJobPostings,
		GetAptibleJobPostings,
		GetAquabyteJobPostings,
		GetArborJobPostings,
		GetArenaNetJobPostings,
		GetAstranisJobPostings,
		GetAtriumJobPostings,
		GetAuth0JobPostings,
		GetAutoZoneJobPostings,
		GetAware3JobPostings,
		GetAxonJobPostings,
		GetAzerionJobPostings,
		GetBackerKitJobPostings,
		GetBallMetalpackJobPostings,
		GetBankOfAmericaJobPostings,
		GetBazaarVoiceJobPostings,
		GetBeamlyJobPostings,
		GetBelleTireJobPostings,
		GetBenchJobPostings,
		GetBetterLessonJobPostings,
		GetBetterUpJobPostings,
		GetBigHealthJobPostings,
		GetBigscreenJobPostings,
		GetBinanceJobPostings,
		GetBirdJobPostings,
		GetBishopFoxJobPostings,
		GetBitnamiJobPostings,
		GetBittrexJobPostings,
		GetBJCJobPostings,
		GetBlackfynnJobPostings,
		GetBlamelessJobPostings,
		GetBlockstackJobPostings,
		GetBlueOwlJobPostings,
		GetBYNMellonJobPostings,
		GetBombasJobPostings,
		GetBoomSupersonicJobPostings,
		GetBorgWarnerJobPostings,
		GetBoseJobPostings,
		GetBoxLunchJobPostings,
		GetBraintreeJobPostings,
		GetBraveJobPostings,
		GetBrightBytesJobPostings,
		GetBrightwheelJobPostings,
		GetBritecoreJobPostings,
		GetBuildZoomJobPostings,
		GetBuildiumJobPostings,
		GetBustleJobPostings,
		GetBuzzFeedJobPostings,
		GetCAEJobPostings,
		GetCaliberCollisionJobPostings,
		GetCalmJobPostings,
		GetCamblyJobPostings,
		GetCanonicalJobPostings,
		GetCapitalOneJobPostings,
		GetCarbonBlackJobPostings,
		GetCarousellJobPostings,
		GetCartaJobPostings,
		GetCasperJobPostings,
		GetCatalyticJobPostings,
		GetCBInsightsJobPostings,
		GetCelgeneJobPostings,
		GetChangeJobPostings,
		GetChartioJobPostings,
		GetCheddarJobPostings,
		GetChewyJobPostings,
		GetChimpJobPostings,
		GetChronicledJobPostings,
		GetCignaJobPostings,
		GetCiscoMerakiJobPostings,
		GetCitrixJobPostings,
		GetCityAndCountyOfDenverJobPostings,
		GetClerkyJobPostings,
		GetClickTimeJobPostings,
		GetCloseJobPostings,
		GetCloudBeesJobPostings,
		GetCloudflareJobPostings,
		GetCloudreachJobPostings,
		GetCobaltRoboticsJobPostings,
		GetCocaColaJobPostings,
		GetCockroachLabsJobPostings,
		GetCodacyJobPostings,
		GetCodeOceanJobPostings,
		GetCodecademyJobPostings,
		GetCoffeeMeetsBagelJobPostings,
		GetCoinbaseJobPostings,
		GetColossalJobPostings,
		GetComcastJobPostings,
		GetCommonJobPostings,
		GetCompassJobPostings,
		GetCompassGroupJobPostings,
		GetConductorTechnologiesJobPostings,
		GetCornellUniversityJobPostings,
		GetConsensysJobPostings,
		GetContrastSecurityJobPostings,
		GetConvoyJobPostings,
		GetCoreScientificJobPostings,
		GetCorelightJobPostings,
		GetCoupaJobPostings,
		GetCourseraJobPostings,
		GetCreditSesameJobPostings,
		GetCrowdStrikeJobPostings,
		GetCruiseJobPostings,
		GetCruxJobPostings,
		GetCuralateJobPostings,
		GetDahmakanJobPostings,
		GetDarkstoreJobPostings,
		GetDaticaJobPostings,
		GetDattoJobPostings,
		GetDaznJobPostings,
		GetDegreedJobPostings,
		GetDeliverooJobPostings,
		GetDellJobPostings,
		GetDigitalOceanJobPostings,
		GetDivvyHomesJobPostings,
		GetDnBJobPostings,
		GetDockerJobPostings,
		GetDominoJobPostings,
		GetDoorDashJobPostings,
		GetDotsJobPostings,
		GetDrChronoJobPostings,
		GetDropJobPostings,
		GetDuoLingoJobPostings,
		GetDuoSecurityJobPostings,
		GetEarlyWarningJobPostings,
		GetEatonJobPostings,
		GetEburyJobPostings,
		GetEdenJobPostings,
		GetElasticJobPostings,
		GetEmbarkJobPostings,
		GetEpicGamesJobPostings,
		GetEricssonJobPostings,
		GetERMJobPostings,
		GetEssentialJobPostings,
		GetEventbriteJobPostings,
		GetEvercommerceJobPostings,
		GetEvernoteJobPostings,
		GetExpediaJobPostings,
		GetExpensifyJobPostings,
		GetFarmersBusinessNetworkJobPostings,
		GetFarmersInsuranceJobPostings,
		GetFastlyJobPostings,
		GetFatLlamaJobPostings,
		GetFedexJobPostings,
		GetFetchRevJobPostings,
		GetFICOJobPostings,
		GetFictivJobPostings,
		GetFingerFoodStudiosJobPostings,
		GetFirstJobPostings,
		GetFondJobPostings,
		GetForwardJobPostings,
		GetFossaJobPostings,
		GetFrontJobPostings,
		GetFuboTVJobPostings,
		GetGameChangerJobPostings,
		GetGatesFoundationJobPostings,
		GetGeckoboardJobPostings,
		GetGeneralAssemblyJobPostings,
		GetGenospaceJobPostings,
		GetGitHubJobPostings,
		GetGitLabJobPostings,
		GetGizmodoJobPostings,
		GetGlowJobPostings,
		GetGoDaddyJobPostings,
		GetGoatJobPostings,
		GetGojekJobPostings,
		GetGovPredictJobPostings,
		GetGradientJobPostings,
		GetGradleJobPostings,
		GetGrammarlyJobPostings,
		GetGreenpeaceJobPostings,
		GetGridspaceJobPostings,
		GetGrimmJobPostings,
		GetGuerrillaJobPostings,
		GetGunIoJobPostings,
		GetGustoJobPostings,
		GetHackerOneJobPostings,
		GetHashiCorpJobPostings,
		GetHazelAnalyticsJobPostings,
		GetHelloAlfredJobPostings,
		GetHelloFreshJobPostings,
		GetHelloSignJobPostings,
		GetHeycarJobPostings,
		GetHifyreJobPostings,
		GetHopsyJobPostings,
		GetImageworksJobPostings,
		GetImpossibleFoodsJobPostings,
		GetInVisionJobPostings,
		GetInboxLabJobPostings,
		GetInfluxDBJobPostings,
		GetInputJobPostings,
		GetInsightsoftwareJobPostings,
		GetInstabaseJobPostings,
		GetInstacartJobPostings,
		GetInstructureJobPostings,
		GetInstrumentalAIJobPostings,
		GetInventablesJobPostings,
		GetInvitaeJobPostings,
		GetIOTAJobPostings,
		GetIrisAutomationJobPostings,
		GetIronOxJobPostings,
		GetIroncladJobPostings,
		GetIssuuJobPostings,
		GetJDAJobPostings,
		GetJellyfishJobPostings,
		GetJetJobPostings,
		GetJoorJobPostings,
		GetJourneraJobPostings,
		GetJournyJobPostings,
		GetKantarJobPostings,
		GetKardJobPostings,
		GetKariusJobPostings,
		GetKayakJobPostings,
		GetKhanAcademyJobPostings,
		GetKikJobPostings,
		GetKinnekJobPostings,
		GetKiteJobPostings,
		GetKlarnaJobPostings,
		GetKoddiJobPostings,
		GetKohlsJobPostings,
		GetKrakenJobPostings,
		GetLaunchDarklyJobPostings,
		GetLendingTreeJobPostings,
		GetLeverJobPostings,
		GetLightStepJobPostings,
		GetLighthouseStudiosJobPostings,
		GetLiltJobPostings,
		GetLimeJobPostings,
		GetLimeadeJobPostings,
		GetLinuxFoundationJobPostings,
		GetLiveNationJobPostings,
		GetLogDNAJobPostings,
		GetLogitechJobPostings,
		GetLookerJobPostings,
		GetLucidJobPostings,
		GetLyftJobPostings,
		GetLyricJobPostings,
		GetMagicLeapJobPostings,
		GetMajorLeagueBaseballPostings,
		GetMakeSchoolJobPostings,
		GetMakeSpaceJobPostings,
		GetManageBbyQJobPostings,
		GetMapboxJobPostings,
		GetMarriottJobPostings,
		GetMastercardJobPostings,
		GetMattermostJobPostings,
		GetMavenClinicJobPostings,
		GetMavensJobPostings,
		GetMcDonaldsJobPostings,
		GetMcKessonJobPostings,
		GetMeasurablJobPostings,
		GetMedMenJobPostings,
		GetMediumJobPostings,
		GetMessageBirdJobPostings,
		GetMetalToadJobPostings,
		GetMightyNetworksJobPostings,
		GetModernizeJobPostings,
		GetModsyJobPostings,
		GetMongoDBJobPostings,
		GetMotorolaSolutionsJobPostings,
		GetMountSinaiJobPostings,
		GetMovableInkJobPostings,
		GetMuxJobPostings,
		GetNarvarJobPostings,
		GetNashJobPostings,
		GetNationwideJobPostings,
		GetNetlifyJobPostings,
		GetNeuralinkJobPostings,
		GetNewEngenJobPostings,
		GetNewYorkTimesJobPostings,
		GetNewfrontInsuranceJobPostings,
		GetNexientJobPostings,
		GetNextdoorJobPostings,
		GetNianticJobPostings,
		GetNovaJobPostings,
		GetNPMJobPostings,
		GetNS1JobPostings,
		GetNurxJobPostings,
		GetNutanixJobPostings,
		GetNvidiaJobPostings,
		GetNYMediaJobPostings,
		GetNylasJobPostings,
		GetOchsnerJobPostings,
		GetOktaJobPostings,
		GetOmadaHealthJobPostings,
		GetOmazeJobPostings,
		GetOneLoginJobPostings,
		GetOpenAIJobPostings,
		GetOpenCosmosJobPostings,
		GetOpenFinJobPostings,
		GetOpenGovJobPostings,
		GetOpenMarketJobPostings,
		GetOpenPhoneJobPostings,
		GetOpendoorJobPostings,
		GetOptivJobPostings,
		GetOriginJobPostings,
		GetOutschoolJobPostings,
		GetPachydermJobPostings,
		GetPAEJobPostings,
		GetPagerDutyJobPostings,
		GetPalantirJobPostings,
		GetPaloAltoNetworksJobPostings,
		GetPantheonJobPostings,
		GetPaperspaceJobPostings,
		GetPathAIJobPostings,
		GetPathlightJobPostings,
		GetPatreonJobPostings,
		GetPAXJobPostings,
		GetPaytmJobPostings,
		GetPeopleAIJobPostings,
		GetPepsiCoJobPostings,
		GetPersistIQJobPostings,
		GetPetalJobPostings,
		GetPfizerJobPostings,
		GetPinterestJobPostings,
		GetPioneerSquareLabsJobPostings,
		GetPlacepassJobPostings,
		GetPlanGridJobPostings,
		GetPlatformshJobPostings,
		GetPlumeJobPostings,
		GetPolicygeniusJobPostings,
		GetPollEverywhereJobPostings,
		GetPopdogJobPostings,
		GetPostmatesJobPostings,
		GetPraetorianJobPostings,
		GetPredictiveIndexJobPostings,
		GetProcoreJobPostings,
		GetProjekt202JobPostings,
		GetProofpointJobPostings,
		GetProtocolJobPostings,
		GetPsiKickJobPostings,
		GetPushpayJobPostings,
		GetPWCJobPostings,
		GetQualtricsJobPostings,
		GetQualysJobPostings,
		GetQuartzyJobPostings,
		GetQuiddJobPostings,
		GetQuoraJobPostings,
		GetRainforestQAJobPostings,
		GetRapid7JobPostings,
		GetRecurlyJobPostings,
		GetRedditJobPostings,
		GetReifyHealthJobPostings,
		GetRelativityJobPostings,
		GetRelayrJobPostings,
		GetRemarkablyJobPostings,
		GetRemitlyJobPostings,
		GetRemixJobPostings,
		GetReplateJobPostings,
		GetResearchGateJobPostings,
		GetReturntocorpJobPostings,
		GetRingJobPostings,
		GetRiotGamesJobPostings,
		GetRobinhoodJobPostings,
		GetRobloxJobPostings,
		GetRollPayJobPostings,
		GetRollsRoyceJobPostings,
		GetRoosterTeethJobPostings,
		GetRoverJobPostings,
		GetRubrikJobPostings,
		GetRushJobPostings,
		GetSalesforceJobPostings,
		GetSaltLendingJobPostings,
		GetSaltStackJobPostings,
		GetSamsaraJobPostings,
		GetSamsungJobPostings,
		GetSanofiJobPostings,
		GetSauceLabsJobPostings,
		GetScaleAIJobPostings,
		GetScanditJobPostings,
		GetScoopJobPostings,
		GetScreenCloudJobPostings,
		GetScribdJobPostings,
		GetSecondMeasureJobPostings,
		GetSecondSpectrumJobPostings,
		GetSecurityTrailsJobPostings,
		GetSecuronixJobPostings,
		GetSemaphoreSolutionsJobPostings,
		GetSensorTowerJobPostings,
		GetSentryJobPostings,
		GetShapeScaleCraterJobPostings,
		GetShoesJobPostings,
		GetShopKeepJobPostings,
		GetShopifyJobPostings,
		GetSiftJobPostings,
		GetSignalJobPostings,
		GetSimpliSafeJobPostings,
		GetSkillshareJobPostings,
		GetSkipJobPostings,
		GetSkydioJobPostings,
		GetSlackJobPostings,
		GetSmarkingJobPostings,
		GetSmartsheetJobPostings,
		GetSnapJobPostings,
		GetSnapRaiseJobPostings,
		GetSnapTravelJobPostings,
		GetSnapdocsJobPostings,
		GetSnowflakeJobPostings,
		GetSonatypeJobPostings,
		GetSonyPlayStationJobPostings,
		GetSourceDJobPostings,
		GetSourceressJobPostings,
		GetSpaceflightIndustriesJobPostings,
		GetSpaceXJobPostings,
		GetSparkswapJobPostings,
		GetSpotHeroJobPostings,
		GetSpotfrontJobPostings,
		GetSpringboardJobPostings,
		GetSproutSocialobPostings,
		GetSquarespaceJobPostings,
		GetStackAdaptJobPostings,
		GetStarcityJobPostings,
		GetStarshipJobPostings,
		GetStarskyRoboticsJobPostings,
		GetStateStreetJobPostings,
		GetStauerJobPostings,
		GetStravaJobPostings,
		GetStreamlabsJobPostings,
		GetStripeJobPostings,
		GetSumoLogicJobPostings,
		GetSurveyGizmoJobPostings,
		GetSurveyMonkeyJobPostings,
		GetSwatJobPostings,
		GetSwissBorgJobPostings,
		GetSymantecJobPostings,
		GetSyscoJobPostings,
		GetSysdigJobPostings,
		GetT1CGJobPostings,
		GetTableauJobPostings,
		GetTablexiJobPostings,
		GetTacoBellJobPostings,
		GetTailoredBrandsJobPostings,
		GetTalaJobPostings,
		GetTaplyticsJobPostings,
		GetTeamableJobPostings,
		GetTelariaJobPostings,
		GetTheAthleticJobPostings,
		GetTheTradeDeskJobPostings,
		GetThumbtackJobPostings,
		GetThunderTokenJobPostings,
		GetTiltingPointJobPostings,
		GetTimeJobPostings,
		GetTimeIncJobPostings,
		GetTopHatJobPostings,
		GetToptalJobPostings,
		GetTransLifelineJobPostings,
		GetTranscendJobPostings,
		GetTransparentSystemsJobPostings,
		GetTrilogyEducationJobPostings,
		GetTripAdvisorJobPostings,
		GetTripleByteJobPostings,
		GetTriplemintJobPostings,
		GetTTTStudiosJobPostings,
		GetTuftAndNeedleJobPostings,
		GetTuneJobPostings,
		GetTutelaJobPostings,
		GetTwilioJobPostings,
		GetTwitchJobPostings,
		GetTyroJobPostings,
		GetUberJobPostings,
		GetUberEtherJobPostings,
		GetUdacityJobPostings,
		GetUhaulJobPostings,
		GetUniregistryJobPostings,
		GetUnisysJobPostings,
		GetUnity3DJobPostings,
		GetUniversalMusicGroupJobPostings,
		GetUniversityOfChicagoJobPostings,
		GetUniversityOfVirginiaJobPostings,
		GetUpstartJobPostings,
		GetUpworkJobPostings,
		GetUserLeapJobPostings,
		GetVenafiJobPostings,
		GetVendJobPostings,
		GetVenmoJobPostings,
		GetVergeGenomicsJobPostings,
		GetVerifoneJobPostings,
		GetVerishopJobPostings,
		GetVeritasJobPostings,
		GetVerizonMediaJobPostings,
		GetVewdJobPostings,
		GetViceJobPostings,
		GetVidyardJobPostings,
		GetVisaJobPostings,
		GetVoleonJobPostings,
		GetVoodooJobPostings,
		GetVoxMediaJobPostings,
		GetVoxterJobPostings,
		GetWealthsimpleJobPostings,
		GetWeb3JobPostings,
		GetWellframeJobPostings,
		GetWGamesJobPostings,
		GetWheelsJobPostings,
		GetWhisperJobPostings,
		GetWholeFoodsJobPostings,
		GetWikimediaJobPostings,
		GetWizelineJobPostings,
		GetWonderJobPostings,
		GetWorkdayJobPostings,
		GetXylemJobPostings,
		GetZendeskJobPostings,
		GetZenefitsJobPostings,
		GetZentailJobPostings,
		GetZeplinJobPostings,
		GetZeroCraterJobPostings,
		GetZeroFoxJobPostings,
		GetZeusJobPostings,
		GetZiplineJobPostings,
		GetZipwhipJobPostings,
		GetZumeJobPostings,
		GetZyrisJobPostings,
	}

	sem := semaphore.NewWeighted(maxNumberOfOpenFiles())

	allJobPostings := make(chan *JobPosting, 10000)

	go func() {
		defer close(allJobPostings)

		wg := sync.WaitGroup{}

		for _, jobPostingSource := range all {
			err := sem.Acquire(ctx, 1)
			if err != nil {
				log.Println(err)
				break
			}

			// funcName := runtime.FuncForPC(reflect.ValueOf(jobPostingSource).Pointer()).Name()

			// log.Printf("Start %v", funcName)

			jobPostingChannel, err := jobPostingSource(ctx)

			if err == nil {
				wg.Add(1)
				go func() {
					defer sem.Release(1)
					defer wg.Done()
					for singlePosting := range jobPostingChannel {
						select {
						case allJobPostings <- singlePosting:
						case <-ctx.Done():
							return
						}
					}

					// log.Printf("Stop %v", funcName)
				}()
			}
		}

		wg.Wait()
	}()

	return allJobPostings
}
